<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="icon" href="images/OB.png" type="image/png">
  <title>Oliver Brady - Timeline</title>
  <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700;900&display.swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="timeline_ss.css">
</head>
<body>

  <div class="container">
    
    <header class="site-header">
      <img src="images/Portrait.JPG" alt="My Portrait" class="profile-portrait">
      <a href="index.html" class="header-link">
        <div class="name-group">
          <h1>Oliver Brady</h1>
          <p>Learning More â€¢ Going Further</p>
        </div>
      </a>
    </header>

    <main class="content">

      <div class="card" id="timeline-title-card">
        <h2 class="timeline-main-title">Timeline</h2>
      </div>

       <div class="card" id="filter-card">
        <h3 class="filter-title">Filter:</h3>
        <div id="filter-container">
          </div>
      </div>


      <div id="timeline-container">
        </div>
    </main>

  </div>

<script>
    let allEvents = [];
    const timelineContainer = document.getElementById('timeline-container');
    const filterContainer = document.getElementById('filter-container');
    const csvFilePath = 'achievements.csv';
    const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];

    document.addEventListener('DOMContentLoaded', () => {
      fetch(csvFilePath)
        .then(response => {
          if (!response.ok) {
            throw new Error('Network response was not ok: ' + response.statusText);
          }
          return response.text();
        })
        .then(csvText => {
          allEvents = parseCSV(csvText);
          
          // Sort events (newest first)
          allEvents.sort((a, b) => {
            const dateA = new Date(a.year, a.month - 1);
            const dateB = new Date(b.year, b.month - 1);
            return dateB - dateA;
          });

          const uniqueCategories = [...new Set(allEvents.flatMap(event => event.category))];
          createCategoryFilters(uniqueCategories.sort());

          filterAndDisplayEvents();
        })
        .catch(error => {
          console.error('Error fetching or parsing CSV:', error);
          timelineContainer.innerHTML = `<p style="color: red;">Error loading timeline data. Please check console for details.</p>`;
        });
    });

    /**
     * Creates the filter checkboxes from the list of unique categories.
     */
    function createCategoryFilters(categories) {
      let filterHTML = categories.map(category => `
        <label class="filter-label">
          <input type="checkbox" name="category" value="${category}" class="filter-checkbox">
          ${category}
        </label>
      `).join('');
      
      filterContainer.innerHTML = filterHTML;

      document.querySelectorAll('.filter-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', filterAndDisplayEvents);
      });
    }

    /**
     * Gets selected categories, filters events, and calls generateTimeline.
     */
    function filterAndDisplayEvents() {
      const selectedCategories = [...document.querySelectorAll('.filter-checkbox:checked')]
        .map(cb => cb.value);

      let filteredEvents;

      if (selectedCategories.length === 0) {
        filteredEvents = allEvents;
      } else {
        filteredEvents = allEvents.filter(event => 
          event.category.some(cat => selectedCategories.includes(cat))
        );
      }
      generateTimeline(filteredEvents);
    }

    /**
     * Parses raw CSV text into an array of event objects.
     * Updated to handle commas inside quotes.
     */
    function parseCSV(text) {
      // 1. Split lines (handles standard newlines)
      const lines = text.trim().split('\n');
      if (lines.length < 2) return [];

      // Regex to match commas ONLY if they are not followed by an odd number of quotes
      // i.e., splits by commas outside of quotes.
      const csvRegex = /,(?=(?:(?:[^"]*"){2})*[^"]*$)/;

      // 2. Parse Headers using the Regex
      const headers = lines[0].split(csvRegex).map(header => header.trim().replace(/^"|"$/g, ''));
      
      const events = [];
      const colIndices = {
        month: headers.indexOf('month'),
        year: headers.indexOf('year'),
        event: headers.indexOf('event'),
        category: headers.indexOf('category'),
        description: headers.indexOf('description'),
        link: headers.indexOf('link'),
      };

      if (Object.values(colIndices).some(index => index === -1)) {
        console.error('CSV headers are incorrect. Expected: month, year, event, category, description, link');
        return [];
      }

      for (let i = 1; i < lines.length; i++) {
        const line = lines[i];
        if (line.trim() === '') continue;
        
        // 3. Parse Row Values using the Regex
        const values = line.split(csvRegex);

        // Helper to clean quotes off the values
        const clean = (val) => val ? val.trim().replace(/^"|"$/g, '').replace(/""/g, '"') : '';

        const eventData = {
          month: parseInt(clean(values[colIndices.month]), 10),
          year: parseInt(clean(values[colIndices.year]), 10),
          event: clean(values[colIndices.event]),
          category: clean(values[colIndices.category]).split('|').map(cat => cat.trim()),
          description: clean(values[colIndices.description]),
          link: clean(values[colIndices.link]),
        };
        events.push(eventData);
      }
      return events;
    }

    /**
     * Generates the timeline HTML and injects it into the DOM.
     */
    function generateTimeline(events) {
      if (events.length === 0) {
        const hasFilters = document.querySelectorAll('.filter-checkbox:checked').length > 0;
        if (hasFilters) {
          timelineContainer.innerHTML = '<p style="text-align: center;">No achievements match the selected categories.</p>';
        } else {
          timelineContainer.innerHTML = '<p style="text-align: center;">No achievements to display.</p>';
        }
        return;
      }
      
      let timelineHTML = '';
      
      events.forEach(event => {
        const dateStr = `${monthNames[event.month - 1]} ${event.year}`;

        const categoryTagsHTML = event.category
          .map(cat => `<div class="timeline-category">${cat}</div>`)
          .join('');

        let eventTitleHTML = event.event;
        if (event.link) {
          eventTitleHTML = `<a href="${event.link}" target="_blank" rel="noopener noreferrer" class="timeline-link">${event.event}</a>`;
        }
        
        timelineHTML += `
          <div class="timeline-item">
            <div class="timeline-date">${dateStr}</div>
            <div class="timeline-content">
              <h3 class="timeline-event-title">${eventTitleHTML}</h3>
              <div class="timeline-category-wrapper">
                ${categoryTagsHTML}
              </div>
              <div class="timeline-description">${event.description}</div>
            </div>
          </div>
        `;
      });

      timelineContainer.innerHTML = timelineHTML;
    }
  </script>
</body>
</html>
